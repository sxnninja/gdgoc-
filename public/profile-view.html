<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>H·ªì s∆° ·ª®ng vi√™n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css" />
    <style>
        .profile-view-page {
            max-width: 680px;
            margin: 48px auto;
        }
        .profile-view-card {
            background: #fff;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 45px -25px rgba(15, 23, 42, 0.35);
        }
        .profile-view-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        .profile-view-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 700;
        }
        .profile-view-title {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 700;
        }
        .profile-view-subtitle {
            margin: 4px 0 0;
            color: #64748b;
        }
        .profile-view-section {
            margin-top: 24px;
        }
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .tag-list .tag {
            background: rgba(79, 70, 229, 0.08);
            color: #4338ca;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .badge-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #0f172a;
            color: #fff;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.82rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        .badge-item:hover {
            filter: brightness(1.05);
        }
        .badge-item span {
            font-size: 0.9rem;
        }
        .profile-view-note {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            background: #eff4ff;
            color: #1e3a8a;
        }
        .profile-view-footer {
            margin-top: 28px;
            font-size: 0.85rem;
            color: #94a3b8;
            text-align: center;
        }
    </style>
</head>
<body>
    <main class="profile-view-page">
        <div id="status" class="profile-view-note" style="display:none;"></div>
        <article class="profile-view-card" id="profileCard" hidden>
            <div class="profile-view-header">
                <div class="profile-view-avatar" id="avatar">U</div>
                <div>
                    <h1 class="profile-view-title" id="displayName">·ª®ng vi√™n</h1>
                    <p class="profile-view-subtitle" id="badgeCount"></p>
                </div>
            </div>
            <section class="profile-view-section">
                <h3>Gi·ªõi thi·ªáu</h3>
                <p id="bio" class="small-note">Ch∆∞a c√≥ m√¥ t·∫£.</p>
            </section>
            <section class="profile-view-section">
                <h3>K·ªπ nƒÉng</h3>
                <div id="skills" class="tag-list"></div>
            </section>
            <section class="profile-view-section">
                <h3>Huy hi·ªáu t·ª´ Doanh nghi·ªáp</h3>
                <div id="badges" class="badge-list"></div>
            </section>
            <p id="badgeInfo" class="profile-view-note">Th√¥ng tin n√†y ch·ªâ bao g·ªìm t√™n hi·ªÉn th·ªã, gi·ªõi thi·ªáu, k·ªπ nƒÉng v√† c√°c huy hi·ªáu do doanh nghi·ªáp c·∫•p.</p>
        </article>
        <p class="profile-view-footer">Projecthub ‚Äì k·∫øt n·ªëi doanh nghi·ªáp v√† ·ª©ng vi√™n.</p>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="/firebase.js"></script>
    <script>
    (function(){
        const statusEl = document.getElementById('status');
        const cardEl = document.getElementById('profileCard');
        const avatarEl = document.getElementById('avatar');
        const nameEl = document.getElementById('displayName');
        const bioEl = document.getElementById('bio');
        const skillsEl = document.getElementById('skills');
        const badgesEl = document.getElementById('badges');
        const badgeCountEl = document.getElementById('badgeCount');
        const badgeInfoEl = document.getElementById('badgeInfo');

        function showStatus(message, isError){
            if(!statusEl) return;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            statusEl.style.background = isError ? '#fee2e2' : '#eff4ff';
            statusEl.style.color = isError ? '#b91c1c' : '#1e3a8a';
        }

        function formatBadgeDate(value){
            if(!value) return '';
            try{
                if(value.toDate) return value.toDate().toLocaleDateString('vi-VN');
                if(value.seconds) return new Date(value.seconds * 1000).toLocaleDateString('vi-VN');
                const date = new Date(value);
                if(!Number.isNaN(date.getTime())){
                    return date.toLocaleDateString('vi-VN');
                }
            }catch(e){ /* ignore */ }
            return '';
        }

        const params = new URLSearchParams(window.location.search);
        const uid = params.get('uid');
        if(!uid){
            showStatus('Thi·∫øu m√£ ·ª©ng vi√™n. Vui l√≤ng quay l·∫°i danh s√°ch ·ª©ng vi√™n.', true);
            return;
        }

        if(!window._firebaseConfig || typeof firebase === 'undefined'){
            showStatus('Firebase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Kh√¥ng th·ªÉ t·∫£i h·ªì s∆°.', true);
            return;
        }

        function ensureFirebase(){
            if(firebase.apps && firebase.apps.length) return true;
            try{
                firebase.initializeApp(window._firebaseConfig);
                return true;
            }catch(e){
                console.warn('Firebase init error', e);
                return false;
            }
        }

        if(!ensureFirebase() || !firebase.firestore){
            showStatus('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Firestore.', true);
            return;
        }

        showStatus('ƒêang t·∫£i h·ªì s∆°...', false);

        firebase.firestore().collection('users').doc(uid).get()
            .then(function(doc){
                if(!doc.exists){
                    showStatus('Kh√¥ng t√¨m th·∫•y h·ªì s∆° c·ªßa ·ª©ng vi√™n n√†y.', true);
                    return;
                }
                const data = doc.data() || {};
                const displayName = data.displayName || '·ª®ng vi√™n';
                const bio = data.bio || 'Ch∆∞a c√≥ m√¥ t·∫£.';
                const skills = Array.isArray(data.skills) ? data.skills : [];
                const badges = Array.isArray(data.badges) ? data.badges : [];

                nameEl.textContent = displayName;
                bioEl.textContent = bio;
                avatarEl.textContent = displayName.charAt(0).toUpperCase();

                skillsEl.innerHTML = '';
                if(skills.length){
                    skills.forEach(function(skill){
                        const tag = document.createElement('span');
                        tag.className = 'tag';
                        tag.textContent = skill;
                        skillsEl.appendChild(tag);
                    });
                }else{
                    skillsEl.innerHTML = '<span class="small-note">Ch∆∞a c·∫≠p nh·∫≠t.</span>';
                }

                badgesEl.innerHTML = '';
                if(badges.length){
                    if(badgeInfoEl){
                        badgeInfoEl.textContent = 'Ch·ªçn huy hi·ªáu ƒë·ªÉ xem th√¥ng tin chi ti·∫øt.';
                    }
                    badges.forEach(function(badge){
                        const data = typeof badge === 'string' ? { name: badge } : (badge || {});
                        const badgeName = data.name || badge || 'Huy hi·ªáu';
                        const badgeEl = document.createElement('button');
                        badgeEl.type = 'button';
                        badgeEl.className = 'badge-item';
                        badgeEl.innerHTML = '<span>üèÖ</span>' + badgeName;
                        const issuer = data.issuedByName || data.issuedByEmail || '';
                        const projectName = data.projectTitle || '';
                        const reason = data.reason || '';
                        const issuedAtHuman = formatBadgeDate(data.issuedAt);
                        const infoTitleParts = [];
                        if(issuer) infoTitleParts.push(issuer);
                        if(projectName) infoTitleParts.push(projectName);
                        badgeEl.title = infoTitleParts.join(' ¬∑ ') || badgeName;
                        badgeEl.addEventListener('click', function(){
                            if(!badgeInfoEl) return;
                            const parts = [];
                            if(issuer){
                                parts.push(`${issuer} ƒë√£ c·∫•p huy hi·ªáu "${badgeName}"`);
                            }else{
                                parts.push(`Huy hi·ªáu "${badgeName}"`);
                            }
                            if(projectName){
                                parts.push(`cho d·ª± √°n ${projectName}`);
                            }
                            if(reason){
                                parts.push(`L√Ω do: ${reason}`);
                            }
                            if(issuedAtHuman){
                                parts.push(`C·∫•p ng√†y ${issuedAtHuman}`);
                            }
                            badgeInfoEl.textContent = parts.join('. ') + '.';
                        });
                        badgesEl.appendChild(badgeEl);
                    });
                    badgeCountEl.textContent = badges.length + ' huy hi·ªáu ƒë∆∞·ª£c doanh nghi·ªáp c·∫•p';
                }else{
                    badgesEl.innerHTML = '<span class="small-note">Ch∆∞a c√≥ huy hi·ªáu n√†o.</span>';
                    badgeCountEl.textContent = 'Ch∆∞a c√≥ huy hi·ªáu ƒë∆∞·ª£c c·∫•p';
                    if(badgeInfoEl){
                        badgeInfoEl.textContent = 'Th√¥ng tin n√†y ch·ªâ bao g·ªìm t√™n hi·ªÉn th·ªã, gi·ªõi thi·ªáu, k·ªπ nƒÉng v√† c√°c huy hi·ªáu do doanh nghi·ªáp c·∫•p.';
                    }
                }

                cardEl.hidden = false;
                statusEl.style.display = 'none';
            })
            .catch(function(err){
                console.error('T·∫£i h·ªì s∆° th·∫•t b·∫°i', err);
                showStatus('Kh√¥ng th·ªÉ t·∫£i h·ªì s∆° ·ª©ng vi√™n. Vui l√≤ng th·ª≠ l·∫°i sau.', true);
            });
    })();
    </script>
</body>
</html>
